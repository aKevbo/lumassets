"use strict";SharkGame.Lab={tabId:"lab",tabDiscovered:!1,tabSeen:!1,tabName:"Laboratory",tabBg:"img/bg/bg-lab.png",get sceneImage(){return"volcanic"===world.worldType?"":"img/events/misc/scene-lab.png"},get sceneDoneImage(){return"volcanic"===world.worldType?"":"img/events/misc/scene-lab-done.png"},get discoverReq(){return world.worldType,{resource:{science:10}}},listEmpty:!0,get message(){return"volcanic"===world.worldType?"Sort of just off to the side, a group of curious crabs congregate and discuss stuff that we don't understand.":"Sort of just off to the side, the science sharks congregate and discuss things with words you've never heard before."},get messageDone(){return"volcanic"===world.worldType?"Sort of just off to the side, the researchers are compiling their work and filing it away.<br/>Looks like that's it! No more things to figure out.":"Sort of just off to the side, the science sharks quietly wrap up their badly disguised party and pretend to work.<br/>Looks like that's it! No more things to figure out."},init(){const e=SharkGame.Lab;SharkGame.TabHandler.registerTab(this),e.resetUpgrades()},setup(){_.each(SharkGame.Upgrades.purchaseQueue,(e=>{SharkGame.Lab.addUpgrade(e,"load")})),SharkGame.TabHandler.updateRegistration(this)},resetUpgrades(){SharkGame.Upgrades.purchaseQueue=void 0,SharkGame.Upgrades.purchased.splice(0);const e={};$.each(SharkGame.ModifierTypes.upgrade,((a,r)=>{e[a]={},$.each(r,((r,s)=>{s.category="upgrade",s.type=a,e[a][r]=s.defaultValue}))})),SharkGame.ResourceMap.forEach(((a,r)=>{SharkGame.ModifierMap.get(r).upgrade=_.cloneDeep(e)}))},switchTo(){const e=SharkGame.Lab,a=$("#content"),r=SharkGame.Upgrades.getUpgradeTable(),s=$("<div>").attr("id","tabMessage");SharkGame.Settings.current.showTabImages&&s.css("background-image","url('"+e.tabBg+"')"),a.append(s),e.updateMessage(!0);const t=$("<div>").attr("id","buttonLeftContainer");t.append($("<div>").attr("id","buttonList").addClass("lab").append($("<h3>").html("Available Upgrades"))),a.append(t),a.append($("<div>").attr("id","upgradeList")),a.append($("<div>").addClass("clear-fix")),e.updateUpgradeList(),e.update(),e.setHint(r)},setHint(e,a){const r=SharkGame.Lab;if(r.allResearchDone()){let e;if("volcanic"===world.worldType)e="We rest content, sure that our work is done.";else e="The scientists rest content, sure that they're done with their work.";$("#buttonList").html($("<p>").html(e)),a&&r.updateMessage()}else if(r.listEmpty){let a;if("volcanic"===world.worldType)a="The crabs are out of ideas, but there are always more discoveries to be made.";else a="The scientists are out of ideas, but there are always more discoveries to be made.";$("#buttonList").html($("<p>").html(a));const s=_.find(e,((e,a)=>r.isUpgradePossible(a)&&!r.isUpgradeVisible(a)&&_.has(e,"required.upgrades")&&_.every(e.required.upgrades,(e=>SharkGame.Upgrades.purchased.includes(e)))));if(void 0===s)return;let t;_.has(s,"required.seen")&&(t=_.find(s.required.seen,(e=>world.doesResourceExist(e)))),t?$("#buttonList").append($("<p>").html("You get the feeling that "+sharktext.getResourceName(t,!1,2,sharkcolor.getElementColor("buttonList"))+" may be the key.")):log.addError(`There is a possible, undiscovered upgrade (${s}), but no valid hint resource.`)}},update(){const e=SharkGame.Lab,a=$("#buttonList"),r=SharkGame.Upgrades.getUpgradeTable();e.listEmpty=!0,$.each(r,((r,s)=>{if(SharkGame.Upgrades.purchased.includes(r))return;if($("#"+r).length>0)e.listEmpty=!1,e.updateLabButton(r);else{let t=!0;if(s.required&&(s.required.upgrades&&(t=t&&this.areRequiredUpgradePrereqsPurchased(r)),t=t&&e.isUpgradePossible(r)&&e.isUpgradeVisible(r)),t){e.listEmpty=!1;const t=SharkGame.Lab.getResearchEffects(s),d=SharkGame.Button.makeButton(r,s.name+"<br/>"+s.desc+"<br/>"+t,a,e.onLabButton);e.updateLabButton(r),SharkGame.Settings.current.showAnimations&&d.hide().css("opacity",0).slideDown(50).animate({opacity:1},{duration:50,done:e=>e.elem.style=null})}}}))},areRequiredUpgradePrereqsPurchased(e){const a=SharkGame.Upgrades.getUpgradeData(SharkGame.Upgrades.getUpgradeTable(),e);return!a.required||_.every(a.required.upgrades,(e=>SharkGame.Upgrades.purchased.includes(e)))},updateLabButton(e){const a=$("#"+e),r=SharkGame.Upgrades.getUpgradeData(SharkGame.Upgrades.getUpgradeTable(),e),s=r.cost;let t;t=!!$.isEmptyObject(s)||res.checkResources(s);const d=SharkGame.Lab.getResearchEffects(r);let i=r.name+"<br/>"+r.desc+"<br/>"+d;const o=sharktext.resourceListToString(s,!t,sharkcolor.getElementColor(e));""!==o&&(i+="<br/>Cost: "+o),t?a.removeClass("disabled"):a.addClass("disabled");const n=$(document.createElement("button"));n.html(i);const c="technologies/"+e;if(SharkGame.Settings.current.showIcons){const e=SharkGame.changeSprite(SharkGame.spriteIconPath,c,null,"general/missing-technology");e&&(e.addClass("button-icon"),n.prepend(e))}a.html()!==n.html()&&a.html(n.html())},updateMessage(e){const a=SharkGame.Lab,r=a.allResearchDone();let s=r?a.messageDone:a.message,t=r?a.sceneDoneImage:a.sceneImage;t||(t="img/events/misc/missing.png");const d=$("#tabMessage");SharkGame.Settings.current.showTabImages&&(s=`<img width=400 height=200 src='${t}' id='tabSceneImage'>${s}`,d.css(`background-image", "url('${a.tabBg}')`)),!e&&SharkGame.Settings.current.showAnimations?d.animate({opacity:0},200,(()=>{$(d).animate({opacity:1},200).html(s)})):d.html(s)},onLabButton(e){if($(this).hasClass("disabled"))return;const a=SharkGame.Upgrades.getUpgradeTable();let r;if("object"==typeof e){if($(this).hasClass("disabled"))return;if(e=$(this).attr("id"),r=SharkGame.Upgrades.getUpgradeData(a,e),SharkGame.Upgrades.purchased.includes(e))return void $(this).remove();res.checkResources(r.cost)&&($(this).remove(),res.changeManyResources(r.cost,!0),SharkGame.Lab.addUpgrade(e),r.researchedMessage&&log.addMessage(r.researchedMessage))}else if(!_.isUndefined(e)){if(r=SharkGame.Upgrades.getUpgradeData(a,e),SharkGame.Upgrades.purchased.includes(e))return;res.checkResources(r.cost)&&(res.changeManyResources(r.cost,!0),SharkGame.Lab.addUpgrade(e),r.researchedMessage&&log.addMessage(r.researchedMessage)),"lab"===SharkGame.Tabs.current&&$(`#${e}`).remove()}"lab"===SharkGame.Tabs.current&&(SharkGame.Lab.update(),SharkGame.Lab.setHint(a,!0))},addUpgrade(e){const a=SharkGame.Upgrades.getUpgradeData(SharkGame.Upgrades.getUpgradeTable(),e);if(a&&!SharkGame.Upgrades.purchased.includes(e)){SharkGame.Upgrades.purchased.push(e),SharkGame.Gate.checkUpgradeRequirements(e),a.effect&&$.each(a.effect,((e,a)=>{$.each(a,((a,r)=>{res.applyModifier(e,a,r)}))})),a.events&&_.each(a.events,(e=>{SharkGame.Events[e].trigger()}));const r=$("#upgradeList > ul"),s=$("<li>").html(`${a.name}<br/><span class='medDesc'>${a.effectDesc}</span>`);SharkGame.Settings.current.showAnimations?s.hide().css("opacity",0).prependTo(r).slideDown(50).animate({opacity:1},100):s.prependTo(r),SharkGame.flags.upgradeTimes||(SharkGame.flags.upgradeTimes={});const t=SharkGame.flags.upgradeTimes[e];t?console.log(`Added upgrade ${a.name} at: ${sharktext.formatTime(t)}`):(console.log(`Added upgrade ${a.name} at: ${sharktext.formatTime(sharktime.getRunTime())}`),SharkGame.flags.upgradeTimes[e]=sharktime.getRunTime()),res.updateResourcesTable()}},allResearchDone(){const e=SharkGame.Upgrades.getUpgradeTable(),a=SharkGame.Lab;let r=!0;return $.each(e,(e=>{a.isUpgradePossible(e)&&(r=r&&SharkGame.Upgrades.purchased.includes(e)&&a.isUpgradeVisible(e))})),r},findAllAffordableUpgrades(){const e=[],a=SharkGame.Upgrades.getUpgradeTable();return $.each(a,(r=>{if(!this.isUpgradePossible(r)||!this.isUpgradeVisible(r)||SharkGame.Upgrades.purchased.includes(r))return!0;res.checkResources(SharkGame.Upgrades.getUpgradeData(a,r).cost)&&this.areRequiredUpgradePrereqsPurchased(r)&&e.push(r)})),e},isUpgradePossible(e){const a=SharkGame.Lab,r=SharkGame.Upgrades.getUpgradeData(SharkGame.Upgrades.getUpgradeTable(),e);let s=!0;if(!r)return!1;if(r.required){if(r.required.resources){let e=!1;_.each(r.required.resources,(a=>{e=e||world.doesResourceExist(a)})),s=s&&e}s=s&&_.every(r.required.upgrades,(e=>a.isUpgradePossible(e))),s=s&&_.every(r.required.totals,((e,a)=>res.getTotalResource(a)>=e)),s=s&&_.every(r.cost,((e,a)=>world.doesResourceExist(a)))}return s},isUpgradeVisible(e){const a=SharkGame.Upgrades.getUpgradeData(SharkGame.Upgrades.getUpgradeTable(),e);return!_.has(a,"required.seen")||_.some(a.required.seen,(e=>res.getTotalResource(e)>0))},getResearchEffects(e){const a=sharkcolor.getVariableColor("--color-light").replace(/[^0-9a-f]/gi,"");let r=parseInt(a.substr(0,2),16)/1.3,s=parseInt(a.substr(2,2),16)/1.3,t=parseInt(a.substr(4,2),16)/1.3;r=parseInt(r).toString(16),s=parseInt(s).toString(16),t=parseInt(t).toString(16);const d="#"+r+s+t,i=[];return $.each(e.effect,((e,a)=>{$.each(a,((a,r)=>{const s=SharkGame.ModifierReference.get(e).effectDescription(r,a,d);world.doesResourceExist(a)&&""!==s&&i.push(s)}))})),e.customEffect&&i.push(e.customEffect(d)),"<span class='medDesc' class='click-passthrough'>(Effects: "+(i.length>0?i.join(", "):"???")+")</span>"},updateUpgradeList(){const e=SharkGame.Upgrades.getUpgradeTable(),a=$("#upgradeList");a.empty(),a.append($("<h3>").html("Researched Upgrades"));const r=$("<ul>"),s=[];$.each(e,(e=>{SharkGame.Upgrades.purchased.includes(e)&&s.unshift(e)}));for(const a of s){const s=SharkGame.Upgrades.getUpgradeData(e,a);r.append($("<li>").html(`${s.name}<br/><span class='medDesc'>${s.effectDesc}</span>`))}a.append(r)}};