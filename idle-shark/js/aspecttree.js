"use strict";const BUTTON_BORDER_RADIUS=5,CANVAS_WIDTH=800,CANVAS_HEIGHT=600,LEFT_EDGE=1200,TOP_EDGE=1250,RIGHT_EDGE=-400,BOTTOM_EDGE=-150,SPRITE_SHEET=new Image,EVENT_SPRITE_SHEET=new Image;SPRITE_SHEET.src="img/sharksprites.png",EVENT_SPRITE_SHEET.src="img/sharkeventsprites.png",SharkGame.AspectTree={context:void 0,pointerType:"mouse",previousButton:void 0,staticButtons:{respec:{posX:10,get posY(){return 10},width:30,height:30,name:"Respec",description:"Toggles respec mode.",getEffect:()=>tree.refundMode?"Deactivate respec mode.":"Activate respec mode to refund aspects (if possible) on click.",clicked(){tree.toggleRefundMode(),tree.updateTooltip(this)},getUnlocked:()=>SharkGame.Aspects.cleanSlate.level>0,getOn:()=>tree.refundMode},respecAll:{posX:10,get posY(){return tree.staticButtons.respec.posY+tree.staticButtons.respec.height+10},width:30,height:30,name:"Respec All",description:"Respecs all aspects.",getEffect:()=>"Respec ALL refundable aspects.",clicked(){confirm("Are you sure you want to respec ALL refundable aspects?")&&tree.respecTree()},getUnlocked:()=>SharkGame.Aspects.cleanSlate.level>0,getOn:()=>!1},debug:{posX:760,posY:10,width:30,height:30,name:"Debug",description:"Toggles debug mode.",getEffect:()=>tree.debugMode?"Deactivate debug mode.":"Activate debug mode to freely change levels of aspects.",clicked(){tree.toggleDebugMode(),tree.updateTooltip(this)},getUnlocked:()=>SharkGame.persistentFlags.debug,getOn:()=>tree.debugMode}},requirementReference:{},init(){$.each(SharkGame.Aspects,((e,t)=>{_.each(t.prerequisites,(s=>{_.has(t,"requiredBy")||(t.requiredBy=[]),_.has(SharkGame.Aspects,s)&&(_.has(SharkGame.Aspects[s],"requiredBy")||(SharkGame.Aspects[s].requiredBy=[]),SharkGame.Aspects[s].requiredBy.push(e))})),t.level=0,SharkGame.persistentFlags.destinyRolls&&(SharkGame.persistentFlags.destinyRolls=0),SharkGame.persistentFlags.patience&&(SharkGame.persistentFlags.patience=0)})),tree.refundMode=!1,tree.debugMode=!1},setup(){SharkGame.missingAspects?(res.setResource("essence",res.getTotalResource("essence")),_.each(SharkGame.Aspects,(e=>{e.level=0})),SharkGame.PaneHandler.showAspectWarning()):_.each(SharkGame.Aspects,(e=>{e.deprecated&&tree.refundLevels(e)})),tree.resetScoutingRestrictions(),tree.applyScoutingRestrictionsIfNeeded(),tree.applyAspects(),SharkGame.persistentFlags.patience&&(SharkGame.Aspects.patience.level&&res.changeResource("essence",2*(SharkGame.Aspects.patience.level+1)**2),SharkGame.persistentFlags.patience=void 0),res.setResource("aspectAffect",1),res.setTotalResource("aspectAffect",1),tree.generateRequirementReference()},drawTree:(e=!0)=>e?tree.drawTable():tree.drawCanvas(),drawTable(e=$("<table>")){e.html("").attr("id","aspectTable");const t=$("<thead>").append($("<th>").html("Name").attr("scope","col"));function s(t){const s=t.currentTarget.getAttribute("data-aspectId");SharkGame.Aspects[s].clicked(t),tree.updateEssenceCounter(),requestAnimationFrame((()=>{tree.drawTable(e)}))}t.append($("<th>").html("Description").attr("scope","col")),t.append($("<th>").html("Level").attr("scope","col")),t.append($("<th>").html("Cost").attr("scope","col")),e.append(t);const r=$("<tbody>");return $.each(SharkGame.Aspects,((e,t)=>{if(t.deprecated)return;const a=tree.requirementReference[e];if(!a.revealed)return;let o="",n="";a.prereqsMet||0!==t.level?a.locked?n="This aspect is locked. "+a.locked:a.isolated&&(n="This aspect's prerequisites aren't met, even though you have levels in it."):n="With your infinite vision, you can see this aspect, but cannot buy it.",o=" A"+(t.level?" level "+t.level:"")+(t.core?" core aspect":t.level?" aspect":"n aspect")+(t.core&&t.noRefunds?",":"")+(t.noRefunds?" with no refunds":"")+". ";const l=$("<th>").html(t.name).addClass("aspectTableName").attr("rowspan","3").attr("scope","rowgroup"),c=$("<td>").append(o+n),i=$("<tr>").append(l).append(c);i.append($("<td>")),i.append($("<td>").html(a.max?"N/A":t.getCost(t.level)).attr("rowspan","3"));const p=$("<tr>");t.level>0?p.append($("<td>").html(`CURRENT: ${t.getEffect(t.level)}`)):p.append($("<td>").html("CURRENT: Not bought, no effect.")),p.append($("<td>").html(t.level));const d=$("<tr>");a.max?(d.append($("<td>").html("NEXT: Already at maximum level.")),d.append($("<td>").html("N/A"))):(d.append($("<td>").html(`NEXT: ${t.getEffect(t.level+1)}`)),d.append($("<td>").html(`${t.level+1}`))),_.each([i,d,p],(t=>{t.attr("data-aspectId",e).on("click",s).attr("aria-role","button").attr("disabled",a.prereqsMet.toString())})),r.append(i),r.append(p),r.append(d)})),e.append(r),e},drawCanvas(){const e=document.createElement("canvas");return e.id="treeCanvas",e.setAttribute("width","800px"),e.setAttribute("height","600px"),$(e).on("mouseenter mousemove mouseleave wheel click touchstart touchmove touchend touchcancel",tree.updateMouse),$(e).on("click",tree.click),tree.context=e.getContext("2d",{alpha:!1,desynchronized:!0}),$("body").css("overscroll-behavior-x","none"),e},initTree(){this.panzoom=panzoom($("canvas")[0],{maxZoom:2,minZoom:.8,bounds:{top:450,right:400,bottom:650,left:400},boundsDisabledForZoom:!0,smoothScroll:{amplitude:.05},onTouch:()=>!1,beforeMouseDown:e=>"treeCanvas"!==e.target.id||void 0!==this.getButtonUnderMouse(e),beforeWheel:e=>"treeCanvas"!==e.target.id}),this.panzoom.on("transform",(()=>{requestAnimationFrame(tree.render)})),tree.render()},getCursorPositionInCanvas(e,t){const s=e.getBoundingClientRect();return{posX:(t.clientX||t.targetTouches[0]?.clientX||t.changedTouches[0].clientX)-s.left,posY:(t.clientY||t.targetTouches[0]?.clientY||t.changedTouches[0].clientY)-s.top}},getButtonUnderMouse(e){const t=tree.context,s=tree.getCursorPositionInCanvas(t.canvas,e),r=this.panzoom.getTransform();if(gateway.transitioning)return;const a=_.find(tree.staticButtons,(({posX:e,posY:t,width:r,height:a})=>s.posX-e>=0&&s.posY-t>=0&&s.posX-e<=r&&s.posY-t<=a));if(void 0!==a&&(!a.getUnlocked||a.getUnlocked()))return a;return _.find(SharkGame.Aspects,(({posX:e,posY:t,width:a,height:o,prerequisites:n,level:l})=>{if(_.some(n,(e=>0===SharkGame.Aspects[e].level))&&!SharkGame.Aspects.infinityVision.level&&!l)return;const c=(s.posY-r.y)/r.scale,i=(s.posX-r.x)/r.scale;return i>=e&&c>=t&&i<=e+a&&c<=t+o}))},updateMouse(e){const t="mouseleave"===e.type?void 0:tree.getButtonUnderMouse(e);tree.updateTooltip(t),void 0===t&&(tree.previousButton=t)},click(e){const t=tree.getButtonUnderMouse(e);if(void 0===t)return;const s="mouse"===e.pointerType||1===e.originalEvent.mozInputSource||2===e.originalEvent.mozInputSource;"function"!=typeof t.clicked||!s&&tree.previousButton?.name!==t?.name||t.clicked(e),tree.previousButton=t,requestAnimationFrame(tree.render)},render(){const e=tree.context;if(void 0===e)return;const t=tree.panzoom.getTransform();e.canvas.width=800,e.canvas.height=600,e.font="12px Verdana";const s=getComputedStyle(document.getElementById("backToGateway")),r=s.backgroundColor,a=s.borderTopColor;e.save(),e.fillStyle="#155c4b",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore(),e.translate(t.x,t.y),e.scale(t.scale,t.scale),gateway.completedWorlds.length>=3&&(e.save(),e.lineWidth=5,e.strokeStyle=r,e.setLineDash([15,15]),e.beginPath(),e.moveTo(420,-1e3),e.lineTo(420,2e3),e.stroke(),e.restore(),e.save(),e.fillStyle=getComputedStyle(document.getElementById("backToGateway")).color,e.fillText("on scouting missions",440,10),e.fillText("you can only bring core aspects",440,25),e.fillText("non-core aspects ->",440,60),e.fillText("<- core aspects",300,60),e.fillText("on scouting missions",440,710),e.fillText("you can only bring core aspects",440,725),e.fillText("non-core aspects ->",440,680),e.fillText("<- core aspects",300,680),e.restore()),e.save(),e.lineWidth=5,_.each(SharkGame.Aspects,(({level:t,posX:s,posY:o,width:n,height:l,requiredBy:c,deprecated:i})=>{i||t&&_.each(c,(t=>{const c=SharkGame.Aspects[t];if(c.deprecated)return;e.save();const i=s+n/2,p=o+l/2,d=c.posX+c.width/2,u=c.posY+c.height/2,f=e.createLinearGradient(i,p,d,u);f.addColorStop(0,r),f.addColorStop(1,a),e.strokeStyle=f,0===c.level&&(c.getUnlocked()?e.filter="brightness(40%)":e.filter="brightness(65%)"),e.beginPath(),e.moveTo(i,p),e.lineTo(d,u),e.stroke(),e.restore()}))})),e.restore(),e.save(),e.lineWidth=1,e.fillStyle=r,e.strokeStyle=a,_.each(SharkGame.Aspects,(({posX:t,posY:s,width:r,height:a,icon:o,eventSprite:n,level:l,deprecated:c},i)=>{if(c)return;e.save();const p=tree.requirementReference[i];p.revealed&&(0===l&&(p.locked?e.filter="brightness(25%) saturate(160%)":p.prereqsMet?e.filter="brightness(70%) saturate(150%)":e.filter="brightness(40%) saturate(150%)"),tree.renderButton(e,t,s,r,a,o,n,i),e.restore())})),e.restore(),e.save(),e.scale(1/t.scale,1/t.scale),e.translate(-t.x,-t.y),e.lineWidth=1,e.fillStyle=r,e.strokeStyle=a,_.each(tree.staticButtons,(({posX:t,posY:s,width:o,height:n,icon:l,eventSprite:c},i)=>{const p=tree.staticButtons[i];p.getUnlocked&&!p.getUnlocked()||(p.getOn&&p.getOn()&&(e.fillStyle=a),tree.renderButton(e,t,s,o,n,l||"aspects/static/"+i,c,i),e.fillStyle=r)})),e.restore(),tree.updateEssenceCounter()},renderButton(e,t,s,r,a,o="general/missing-action",n=!1,l){if(e.beginPath(),e.moveTo(t+5,s),e.lineTo(t+r-5,s),e.quadraticCurveTo(t+r,s,t+r,s+5),e.lineTo(t+r,s+a-5),e.quadraticCurveTo(t+r,s+a,t+r-5,s+a),e.lineTo(t+5,s+a),e.quadraticCurveTo(t,s+a,t,s+a-5),e.lineTo(t,s+5),e.quadraticCurveTo(t,s,t+5,s),e.closePath(),e.fill(),e.stroke(),null!==o){"general/missing-action"===o&&SharkGame.Sprites["aspects/"+l]&&(o="aspects/"+l);let c=SharkGame.Sprites[o];void 0===c&&(c=SharkGame.Sprites["general/missing-action"]),e.drawImage(n?EVENT_SPRITE_SHEET:SPRITE_SHEET,c.frame.x,c.frame.y,c.frame.w,c.frame.h,t,s,r,a)}const c=tree.getLittleLevelText(l);c&&(e.fillStyle=getComputedStyle(document.getElementById("backToGateway")).color,e.fillText(c,t+r+5,s+a/2),e.fillStyle=getComputedStyle(document.getElementById("backToGateway")).backgroundColor)},getLittleLevelText(e){const t=tree.requirementReference[e];if(t)return!t.locked&&t.prereqsMet?t.max?"MAX":SharkGame.Aspects[e].level+" / "+SharkGame.Aspects[e].max:void 0},handleClickedAspect(e){tree.refundMode?(e.noRefunds||tree.refundLevels(e),tree.updateRequirementReference(),tree.render()):tree.debugMode?tree.setLevel(e,prompt("Set to what level?")):tree.increaseLevel(e),tree.updateTooltip(e)},increaseLevel(e,t){let s=0;if(!t){if(e.level>=e.max||e.getUnlocked()||_.some(e.prerequisites,(e=>0===SharkGame.Aspects[e].level)))return;if(s=e.getCost(e.level),s>res.getResource("essence"))return}res.changeResource("essence",-s),e.level++,"function"==typeof e.apply&&e.apply("levelUp"),tree.updateRequirementReference()},updateEssenceCounter(){document.getElementById("essenceCount")&&(document.getElementById("essenceCount").innerHTML=sharktext.beautify(res.getResource("essence"),!1,2))},applyAspects(){_.each(SharkGame.Aspects,(e=>{e.level&&"function"==typeof e.apply&&e.apply("init")}))},respecTree(e){e?_.each(SharkGame.Aspects,(e=>{this.refundLevels(e)})):_.each(SharkGame.Aspects,(e=>{e.noRefunds||this.refundLevels(e)})),tree.updateRequirementReference(),"table"===SharkGame.Settings.current.doAspectTable?(this.drawTable(document.getElementById("aspectTable")),this.updateEssenceCounter()):requestAnimationFrame(tree.render)},refundLevels(e){let t=0;for(;e.level;)t=e.getCost(e.level-1),_.isUndefined(t)&&(t=0),res.changeResource("essence",t),e.level-=1},applyScoutingRestrictionsIfNeeded(){gateway.currentlyOnScoutingMission()&&(SharkGame.persistentFlags.aspectStorage||(SharkGame.persistentFlags.aspectStorage={}),$.each(SharkGame.Aspects,((e,t)=>{if(t.core)return!0;SharkGame.persistentFlags.aspectStorage[e]=t.level,SharkGame.Aspects[e].level=0})))},resetScoutingRestrictions(){SharkGame.persistentFlags.aspectStorage||(SharkGame.persistentFlags.aspectStorage={}),$.each(SharkGame.Aspects,(e=>{_.isUndefined(SharkGame.persistentFlags.aspectStorage[e])||(SharkGame.Aspects[e].level=SharkGame.persistentFlags.aspectStorage[e],SharkGame.persistentFlags.aspectStorage[e]=void 0)}))},updateTooltip(e){const t=$("#tooltipbox"),s=tree.context;if(s)if(void 0===e)s.canvas.style.cursor="grab",t.empty().removeClass("forAspectTree forAspectTreeUnpurchased forAspectTreeAffordable");else{let r;if(_.forEach(tree.staticButtons,((t,s)=>{if(t.name===e.name)return r=s,!1})),r)return void(e.getUnlocked&&!e.getUnlocked()||(t.html(e.getEffect()).removeClass("forAspectTree forAspectTreeAffordable").addClass("forAspectTreeUnpurchased"),s.canvas.style.cursor="pointer"));if(_.forEach(SharkGame.Aspects,((t,s)=>{if(t.name===e.name)return r=s,!1})),!r)return void t.empty().removeClass("forAspectTree forAspectTreeUnpurchased forAspectTreeAffordable");const a=tree.requirementReference[r];if(!a)return void t.empty().removeClass("forAspectTree forAspectTreeUnpurchased forAspectTreeAffordable");const o=e.getCost(e.level);if(a.prereqsMet?s.canvas.style.cursor="pointer":e.level?s.canvas.style.cursor="not-allowed":s.canvas.style.cursor="grab",t.addClass("forAspectTree").removeClass("forAspectTreeUnpurchased").removeClass("forAspectTreeAffordable"),a.locked)return void t.addClass("forAspectTreeUnpurchased").html(sharktext.boldString(e.getUnlocked()));const n=tree.getTheoreticalRefundValue(e);tree.refundMode?n&&!e.noRefunds&&t.addClass("forAspectTreeAffordable"):a.affordable&&!a.max&&a.prereqsMet&&t.addClass("forAspectTreeAffordable");let l="";if(0===e.level){let s="";tree.refundMode?e.noRefunds&&(s="NO REFUNDS"):s=`COST: <span class='${a.affordable?"can-afford-aspect":"cant-afford-aspect"}'>${o} ESSENCE</span>`;const r=(e.core?" core aspect":"")+(e.core&&e.noRefunds?", ":"")+(e.noRefunds?"no refunds":"");l=sharktext.boldString(e.name)+`<br /><span class='littleTooltipText'>${r}</span>`+`<br/>${e.getEffect(1)}<br/>`+`<span class='littleTooltipText'>${e.description}</span><br/>`+(tree.debugMode?"":`<hr class='hrForTooltipJuxtapositionInGateway'><span class='bold'>${s}</span>`),t.addClass("forAspectTreeUnpurchased")}else if(e.level<e.max){let t="";t=tree.refundMode?e.noRefunds?"NO REFUNDS":`REFUND VALUE: <span class="can-afford-aspect">${n}</span>`:`COST: <span class='${a.affordable?"can-afford-aspect":"cant-afford-aspect"}'>${o} ESSENCE</span>`;const s="<strong>level "+e.level+"</strong> "+(e.core?" core aspect":" aspect")+(e.noRefunds?", no refunds":"");l=sharktext.boldString(e.name)+`<br /><span class='littleTooltipText'>${s}</span><br />`+e.getEffect(e.level)+`<br /><span class='littleTooltipText'>${e.description}</span><hr class='hrForTooltipSeparationInGateway'><span class='littleTooltipText' class='bold'>NEXT LEVEL:</span><br />`+e.getEffect(e.level+1)+(tree.debugMode?"":`<hr class='hrForTooltipJuxtapositionInGateway'><span class='bold'>${t}</span>`)}else if(void 0===e.level){const t=(e.core?" core aspect":"")+(e.core&&e.noRefunds?", ":"")+(e.noRefunds?"no refunds":"");l=sharktext.boldString(e.name)+`<br /><span class='littleTooltipText'>${t}</span>`+`<br />${e.getEffect(e.level)}`+`<br /><span class='littleTooltipText'>${e.description}</span>`}else{let t="";t=tree.refundMode?e.noRefunds?"NO REFUNDS":`REFUND VALUE: <span class="can-afford-aspect">${n}</span>`:"MAXIMUM LEVEL.";const s="<strong>level "+e.level+"</strong> "+(e.core?" core aspect":" aspect")+(e.noRefunds?", no refunds":"");l=sharktext.boldString(e.name)+`<br /><span class='littleTooltipText'>${s}</span>`+`<br />${e.getEffect(e.level)}`+`<br /><span class='littleTooltipText'>${e.description}</span>`+(tree.debugMode?"":`<hr class='hrForTooltipJuxtapositionInGateway'><strong>${t}</strong></span>`)}t.html(l)}},generateRequirementReference(){tree.requirementReference={},_.forEach(SharkGame.Aspects,((e,t)=>{e.deprecated||(tree.requirementReference[t]={})})),tree.updateRequirementReference()},updateRequirementReference(){const e=tree.requirementReference;_.forEach(SharkGame.Aspects,((t,s)=>{t.deprecated||(e[s].affordable=t.getCost(t.level)<=res.getResource("essence"),e[s].locked=t.getUnlocked()||!1,e[s].prereqsMet=!_.some(t.prerequisites,(e=>0===SharkGame.Aspects[e].level)),e[s].isolated=t.level&&!e[s].prereqsMet,e[s].revealed=e[s].prereqsMet||SharkGame.Aspects.infinityVision.level||t.level,e[s].max=t.level>=t.max)}))},toggleRefundMode(){tree.refundMode?(tree.refundMode=!1,$("#respecModeButton").removeClass("respecMode")):(tree.refundMode=!0,$("#respecModeButton").addClass("respecMode"),tree.debugMode&&tree.toggleDebugMode())},toggleDebugMode(){tree.debugMode?(tree.debugMode=!1,$("#debugModeButton").removeClass("respecMode")):(tree.debugMode=!0,$("#debugModeButton").addClass("respecMode"),tree.refundMode&&tree.toggleRefundMode())},getTheoreticalRefundValue(e){if(!e.level||e.noRefunds)return 0;let t=0,s=e.level-1;for(;s>=0;)t+=e.getCost(s),s-=1;return t},setLevel(e,t){if(!(isNaN(t)||(t=Math.ceil(t))<0))for(t-e.level<0&&(e.level=0);t-e.level>0;)tree.increaseLevel(e,!0)}};